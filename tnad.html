<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practiclick</title>
    <link rel="stylesheet" href="controlpanel1.css">
</head>
<body>
    <div style="max-width:600px;margin:32px auto;padding:24px;">
        <h2 style="text-align:center;">ניהול יומני תרגול</h2>
        <label for="userSelect">בחר משתמש:</label>
        <select id="userSelect" style="width:100%;margin-bottom:18px;"></select>
        <div id="summaryContainer"></div>
    </div>
    <div id="loading-overlay" class="loading-overlay" style="display:none;">טוען...</div>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
        const SUPABASE_URL = 'https://uhdkzqyojjfshsdyrkyd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZGt6cXlvampmc2hzZHlya3lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDc0MDIsImV4cCI6MjA2NTM4MzQwMn0.-NcMckWGJ_Dz5YzzAXRl1VAIcUL8E2XBilicEEX3CVQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const userSelect = document.getElementById('userSelect');
        const summaryContainer = document.getElementById('summaryContainer');
        const loadingOverlay = document.getElementById('loading-overlay');

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        async function fetchSummaries() {
            showLoading(true);
            const { data, error } = await supabase
                .from('summaries')
                .select('name, json');
            showLoading(false);
            if (error) {
                summaryContainer.innerHTML = `<div style="color:red;">שגיאה בטעינת נתונים</div>`;
                return [];
            }
            return data || [];
        }

        function formatTime(minutes) {
            if (typeof minutes !== 'number') return '';
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hrs > 0 ? `${hrs}ש` : ''}${mins}ד`;
        }

        function renderSummary(summary) {
            if (!summary) {
                summaryContainer.innerHTML = '<div>אין נתונים להצגה.</div>';
                return;
            }
            let json = typeof summary.json === 'string' ? JSON.parse(summary.json) : summary.json;
            let html = `
                <div style="background:#23272a;border-radius:10px;padding:24px 18px;box-shadow:0 2px 8px #0006;">
                    <div style="margin-bottom:18px;">
                        <span style="font-size:1.15em;font-weight:bold;color:#60aaff;">משתמש:</span>
                        <span style="font-size:1.15em;">${json.userName || summary.name}</span>
                    </div>
                    <div style="margin-bottom:10px;">
                        <span style="color:#aaa;">שבוע שמתחיל ב:</span>
                        <span>${json.weekStartDate}</span>
                    </div>
                    <div style="margin-bottom:18px;">
                        <span style="color:#aaa;">סה"כ זמן שבועי:</span>
                        <span style="font-weight:bold;color:#00a05e;">${json.totalWeekFormatted}</span>
                    </div>
                    <table style="width:100%;margin-top:8px;border-collapse:collapse;font-size:1.05em;">
                        <thead>
                            <tr style="background:#2f3136;">
                                <th style="text-align:left;padding:8px 10px;border-bottom:2px solid #444;">יום</th>
                                <th style="text-align:left;padding:8px 10px;border-bottom:2px solid #444;">תאריך</th>
                                <th style="text-align:left;padding:8px 10px;border-bottom:2px solid #444;">סה"כ זמן</th>
                                <th style="text-align:left;padding:8px 10px;border-bottom:2px solid #444;">מספר סשנים</th>
                                <th style="text-align:left;padding:8px 10px;border-bottom:2px solid #444;">יומן</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            for (const [i, day] of json.summary.entries()) {
                const logs = day.logs || []; // Default to an empty array if logs is undefined
                html += `
                    <tr style="background:${i%2===0 ? '#23272a' : '#282c34'};">
                        <td style="padding:8px 10px;border-bottom:1px solid #333;">${day.dayName}</td>
                        <td style="padding:8px 10px;border-bottom:1px solid #333;">${day.date}</td>
                        <td style="padding:8px 10px;border-bottom:1px solid #333;">${day.totalTimeFormatted}</td>
                        <td style="padding:8px 10px;border-bottom:1px solid #333;">${day.sessionCount}</td>
                        <td style="padding:8px 10px;border-bottom:1px solid #333;">
                            ${logs.map(log => `
                                <div style="margin-bottom:8px;">
                                    <span style="color:#60aaff;">${formatTime(log.time)}</span>
                                    <span style="color:#aaa;">(${log.mode}, ${log.room || 'Other'})</span>
                                    ${log.note ? `<div style="color:#ffa500;">הערה: ${log.note}</div>` : ''}
                                </div>
                            `).join('')}
                        </td>
                    </tr>
                `;
            }
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            summaryContainer.innerHTML = html;
        }

        async function setup() {
            const summaries = await fetchSummaries();
            // Get unique users
            const users = Array.from(new Set(summaries.map(s => s.name))).sort();
            userSelect.innerHTML = '';
            users.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                userSelect.appendChild(option);
            });
            if (users.length === 0) {
                summaryContainer.innerHTML = '<div>אין משתמשים עם יומן תרגול.</div>';
                return;
            }
            function showSelectedUserSummary() {
                const selected = userSelect.value;
                const summary = summaries.find(s => s.name === selected);
                renderSummary(summary);
            }
            userSelect.onchange = showSelectedUserSummary;
            showSelectedUserSummary();
        }

        setup();
    </script>
</body>
</html>