<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practiclick</title>
    <link rel="stylesheet" href="controlpanel1.css">
    <style>
        #summaryContainer {
            background: var(--card, #1c253b);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 24px rgba(96, 170, 255, 0.2);
            border: 1px solid var(--border, #22304a);
            color: #e0e6f0;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 1rem;
            margin-bottom: 24px;
        }
        #logContainer {
            background: var(--card, #1c253b);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 24px rgba(96, 170, 255, 0.2);
            border: 1px solid var(--border, #22304a);
            color: #e0e6f0;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        th, td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid var(--border, #22304a);
        }
        th {
            background: var(--primary, #60aaff);
            color: #162032;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: var(--input-bg, #202b3d);
        }
        tr:nth-child(odd) {
            background: var(--card, #1c253b);
        }
        #logContainer, #summaryContainer {
            overflow-x: auto;  
        }

        #practiceLogsTable,
        #weeklySummaryTable {
            width: 100%;
            max-width: 100%;
            table-layout: auto;
        }

        #practiceLogsTable th,
        #practiceLogsTable td,
        #weeklySummaryTable th,
        #weeklySummaryTable td {
            word-wrap: break-word;   /* break long text */
            overflow: hidden;
            text-overflow: ellipsis; /* "..." for overflow */
        }
    </style>
</head>
<body>
    <div style="max-width:600px;margin:32px auto;padding:24px;">
        <h2 style="text-align:center;">ניהול יומני תרגול</h2>
        <label for="userSelect">בחר תלמיד:</label>
        <select id="userSelect" style="width:100%;margin-bottom:18px;">
            <option value="">.בחר תלמיד.</option>
        </select>
        <div id="summaryContainer">
            <h3 style="text-align:center;">סיכום שבועי</h3>
            <table id="weeklySummaryTable">
                <thead>
                    <tr>
                        <th>יום</th>
                        <th>תאריך</th>
                        <th>סה"כ זמן</th>
                        <th>מספר סשנים</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="logContainer">
            <h3 style="text-align:center;">יומני תרגול</h3>
            <table id="practiceLogsTable">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>זמן</th>
                        <th>מצב</th>
                        <th>חדר</th>
                        <th>הערה</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div>
            <p>עריכת מצב חדרים</p>
            <label>הכנס שם שיריון</label>
            <input type="text" id="book-name" placeholder="שיעור תופים...">
            <label for="editr">בחר חדר</label>
            <select id="selectr" style="width:100%;margin-bottom:18px;">
                <option value="">.בחר חדר.</option>
                <option value="all">כולם</option>
            </select>
            <label for="editr">בחר שעת התחלה</label>
            <input type="time" id="timeinput" style="width:100%;margin-bottom:18px;">

            <label>בחר תאריך (לא חובה)</label>
            <input type="date" id="dateinput" style="width:100%;margin-bottom:18px;">

            <label">בחר כמות דקות</label>
            <input type="text" id="length" value="45">

            <select name="status_selection" id="status" style="width:100%;margin-bottom:18px;">
                <option value="lesson">בשיעור</option>
                <option value="available">פנוי</option>
                <option value="taken">תפוס</option>
                <option value="unavailable">נעול</option>
            </select><br>
            <button id="usBtn" style="width:100%;margin-bottom:18px;">עדכן מצב</button>
        </div>
    </div>
    <div id="loading-overlay" class="loading-overlay" style="display:none;">טוען...</div>


    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
        const SUPABASE_URL = 'https://uhdkzqyojjfshsdyrkyd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZGt6cXlvampmc2hzZHlya3lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDc0MDIsImV4cCI6MjA2NTM4MzQwMn0.-NcMckWGJ_Dz5YzzAXRl1VAIcUL8E2XBilicEEX3CVQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const userSelect = document.getElementById('userSelect');
        const summaryContainer = document.getElementById('summaryContainer');
        const logContainer = document.getElementById('logContainer');
        const loadingOverlay = document.getElementById('loading-overlay');

        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        async function fetchSummaries() {
            showLoading(true);
            try {
                const { data, error } = await supabase
                    .from('summaries')
                    .select('name, json');
                showLoading(false);
                if (error) {
                    console.error('Error fetching summaries:', error.message);
                    summaryContainer.innerHTML = `<div style="color:red;">שגיאה בטעינת נתונים</div>`;
                    return [];
                }
                // Parse JSON and return summaries
                return data.map(item => ({
                    name: item.name,
                    json: typeof item.json === 'string' ? JSON.parse(item.json) : item.json
                }));
            } catch (err) {
                console.error('Error fetching summaries:', err.message);
                summaryContainer.innerHTML = `<div style="color:red;">שגיאה בטעינת נתונים</div>`;
                return [];
            }
        }

        async function fetchLogs() {
            showLoading(true);
            try {
                const { data, error } = await supabase
                    .from('summaries')
                    .select('json');
                showLoading(false);
                if (error) {
                    console.error('Error fetching logs:', error.message);
                    logContainer.innerHTML = `<div style="color:red;">שגיאה בטעינת יומנים</div>`;
                    return [];
                }
                // Extract logs from the JSON structure
                const logs = data.flatMap(item => {
                    const json = typeof item.json === 'string' ? JSON.parse(item.json) : item.json;
                    return json.summary.flatMap(day => 
                        (day.logs || []).map(log => ({
                            ...log,
                            date: log.date
                        }))
                    );
                });
                return logs;
            } catch (err) {
                console.error('Error fetching logs:', err.message);
                logContainer.innerHTML = `<div style="color:red;">שגיאה בטעינת יומנים</div>`;
                return [];
            }
        }

        function formatTime(ms) {
            if (typeof ms !== 'number' || ms <= 0) return '-';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours > 9 ? hours : '0'+hours}:${minutes > 9 ? minutes : '0'+minutes}:${seconds > 9 ? seconds : '0'+seconds}`;
        }


        function formatDate(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            return date.toLocaleString("he-IL", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }


        function renderWeeklySummary(summary) {
            const weeklySummaryTable = document.getElementById('weeklySummaryTable').querySelector('tbody');
            weeklySummaryTable.innerHTML = '';
            if (!summary || !summary.summary) {
                weeklySummaryTable.innerHTML = '<tr><td colspan="4" style="color:#aaa;">אין נתונים להצגה.</td></tr>';
                return;
            }
            summary.summary.forEach(day => {
                weeklySummaryTable.innerHTML += `
                    <tr>
                        <td>${day.dayName}</td>
                        <td>${day.date}</td>
                        <td>${day.totalTimeFormatted}</td>
                        <td>${day.sessionCount}</td>
                    </tr>
                `;
            });
        }

        function renderPracticeLogs(logs) {
            const practiceLogsTable = document.getElementById('practiceLogsTable');
            if (!practiceLogsTable) {
                console.error('Practice logs table not found.');
                logContainer.innerHTML = `<div style="color:red;">טבלת יומנים לא נמצאה</div>`;
                return;
            }
            const tbody = practiceLogsTable.querySelector('tbody');
            if (!tbody) {
                console.error('Table body for practice logs not found.');
                return;
            }
            tbody.innerHTML = '';
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="color:#aaa;">אין יומנים להצגה.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const formattedDate = formatDate(log.date)
                const formattedTime = formatTime(log.time);
                tbody.innerHTML += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td>${log.mode}</td>
                        <td>${log.room || 'אחר'}</td>
                        <td>${log.note || ''}</td>
                    </tr>
                `;
            });
        }

        async function setup() {
            const summaries = await fetchSummaries();
            const users = Array.from(new Set(summaries.map(s => s.name))).sort();

            users.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                userSelect.appendChild(option);
            });
            if (users.length === 0) {
                summaryContainer.innerHTML = '<div>אין משתמשים עם יומן תרגול.</div>';
                return;
            }
            function showSelectedUserSummary() {
            const selected = userSelect.value;
            if (selected !== '.בחר משתמש.') {
                const summaryObj = summaries.find(s => s.name === selected);
                const summary = summaryObj?.json;

                renderWeeklySummary(summary);

                const logs = summary?.summary?.flatMap(day => 
                    (day.logs || []).map(log => ({
                        ...log,
                        date: log.date,
                        totalTimeFormatted: log.totalTimeFormatted
                    }))
                ) || [];

                renderPracticeLogs(logs);
            }
        }


            userSelect.onchange = showSelectedUserSummary;
            
        }

        setup();
        document.getElementById('userSelect').value = '.בחר משתמש.';

        async function fetchRooms() {
            const { data, error } = await supabase
                .from('rooms')
                .select('name')
                .order('id');
        if (error) {console.error('something went wrong ' + error.message); return}
        return data} 

        async function renderRooms() {
            const selectr = document.getElementById('selectr')
            const rooms = await fetchRooms();
            

            rooms.forEach(name => {
                const option = document.createElement('option');
                option.value = name.name;
                option.textContent = name.name;
                selectr.appendChild(option);
                
            });


        } renderRooms();

        async function updateRStatus() {
            if (document.getElementById('selectr').value != 'all') {
                const room = document.getElementById('selectr').value;
            } else {await supabase.from('rooms').update({status: document.getElementById('status').value}).neq('name', 'somethingrandom');return;}
            const { error } = await supabase
                    .from('rooms')
                    .update({status: document.getElementById('status').value})
                    .eq('name', document.getElementById('selectr').value);
        }

        async function bookAroom() {
            const clock = document.getElementById('timeinput').value;
            const date = document.getElementById('dateinput').value ? document.getElementById('dateinput').value : null;
            const status = document.getElementById('status').value;
            const name = document.getElementById('book-name').value;
            const room = document.getElementById('selectr').value;
            const length = document.getElementById('length').value;

            const { error } = await supabase
                .from('booking')
                .insert({ name: name, room: room, status: status, time: clock, date: date, length: length });
            if (error) {console.error(error.message)}
        } 

        document.getElementById('usBtn').addEventListener('click', async () => {
            console.log(document.getElementById('timeinput').value);
            if (!document.getElementById('timeinput').value) {updateRStatus();}
            else {bookAroom()}
            
        })
    </script>
</body>
</html>